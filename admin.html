<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ğŸ“Š æ¸¬é©—åˆ†æç®¡ç†å¾Œå° (Admin Dashboard)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: 'Inter', sans-serif; background-color: #f7fafc; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .tab-button.active { background-color: #f59e0b; color: white; }
    .data-table th, .data-table td { padding: 0.75rem; border-bottom: 1px solid #e2e8f0; }
    .data-table th { text-align: left; background-color: #edf2f7; }
    .data-table tr:hover { cursor: pointer; }
    .modal { transition: opacity 0.3s ease-in-out; visibility: hidden; opacity: 0; }
    .modal.open { visibility: visible; opacity: 1; }
  </style>
</head>

<body class="p-6">
  <div class="max-w-7xl mx-auto bg-white rounded-xl shadow-2xl p-8">
    <h1 class="text-3xl font-bold text-gray-900 mb-6 border-b-4 border-amber-500 pb-2">
      ğŸ“Š æ¸¬é©—æ•¸æ“šåˆ†æå„€è¡¨æ¿
    </h1>

    <div class="flex flex-wrap gap-4 items-center mb-6 p-4 bg-amber-50 rounded-lg shadow-inner">
      <div class="flex-grow">
        <label for="date_start" class="block text-sm font-medium text-gray-700">èµ·å§‹æ—¥æœŸ</label>
        <input type="date" id="date_start" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
      </div>
      <div class="flex-grow">
        <label for="date_end" class="block text-sm font-medium text-gray-700">çµæŸæ—¥æœŸ</label>
        <input type="date" id="date_end" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
      </div>
      <button onclick="applyFilters()" class="mt-4 px-6 py-2 bg-amber-500 text-white font-semibold rounded-lg shadow-md hover:bg-amber-600 transition duration-150">
        å¥—ç”¨ç¯©é¸
      </button>
    </div>

    <!-- Tabs -->
    <div class="flex space-x-2 border-b border-gray-200 mb-6">
      <button id="tab_events" class="tab-button active px-4 py-2 text-sm font-medium rounded-t-lg bg-amber-500 text-white transition duration-150" onclick="showTab('events')">äº‹ä»¶è¨˜éŒ„ (Events)</button>
      <button id="tab_results" class="tab-button px-4 py-2 text-sm font-medium rounded-t-lg text-gray-700 hover:bg-gray-100 transition duration-150" onclick="showTab('results')">æ¸¬é©—çµæœ (Results)</button>
    </div>

    <!-- Events -->
    <div id="content_events" class="tab-content active">
      <h2 class="text-xl font-semibold mb-4 text-gray-800">æ‰€æœ‰äº‹ä»¶è¨˜éŒ„</h2>
      <p id="event_loading_status" class="text-sm text-gray-500 mb-4">è¼‰å…¥ä¸­...</p>
      <div class="overflow-x-auto rounded-lg shadow-md">
        <table class="data-table min-w-full divide-y divide-gray-200">
          <thead>
            <tr>
              <th class="py-3 px-4 text-sm font-semibold uppercase tracking-wider">æ™‚é–“æˆ³</th>
              <th class="py-3 px-4 text-sm font-semibold uppercase tracking-wider">äº‹ä»¶åç¨±</th>
              <th class="py-3 px-4 text-sm font-semibold uppercase tracking-wider">æœƒè©± ID</th>
              <th class="py-3 px-4 text-sm font-semibold uppercase tracking-wider">ç”¨æˆ¶ ID</th>
              <th class="py-3 px-4 text-sm font-semibold uppercase tracking-wider">é é¢</th>
            </tr>
          </thead>
          <tbody id="event_data_body" class="bg-white divide-y divide-gray-200"></tbody>
        </table>
      </div>
    </div>

    <!-- Results -->
    <div id="content_results" class="tab-content">
      <h2 class="text-xl font-semibold mb-4 text-gray-800">æ‰€æœ‰æ¸¬é©—çµæœ</h2>
      <p id="result_loading_status" class="text-sm text-gray-500 mb-4">è¼‰å…¥ä¸­...</p>
      <div class="overflow-x-auto rounded-lg shadow-md">
        <table class="data-table min-w-full divide-y divide-gray-200">
          <thead>
            <tr>
              <th class="py-3 px-4 text-sm font-semibold uppercase tracking-wider">æ™‚é–“æˆ³</th>
              <th class="py-3 px-4 text-sm font-semibold uppercase tracking-wider">æœƒè©± ID</th>
              <th class="py-3 px-4 text-sm font-semibold uppercase tracking-wider">æ¸¬é©—çµæœå</th>
              <th class="py-3 px-4 text-sm font-semibold uppercase tracking-wider">åˆ†æ•¸è©³æƒ…</th>
            </tr>
          </thead>
          <tbody id="result_data_body" class="bg-white divide-y divide-gray-200"></tbody>
        </table>
      </div>
    </div>

    <!-- Error -->
    <div id="error_message" class="hidden mt-6 p-4 text-sm text-red-700 bg-red-100 rounded-lg" role="alert">
      <p><strong>éŒ¯èª¤ï¼š</strong> ç„¡æ³•å¾å¾Œç«¯è¼‰å…¥æ•¸æ“šã€‚è«‹ç¢ºèªä¼ºæœå™¨æ˜¯å¦å•Ÿå‹•ã€‚</p>
    </div>
  </div>

  <!-- Modal -->
  <div id="detail_modal" class="modal fixed inset-0 z-50 flex items-center justify-center p-4 bg-gray-900 bg-opacity-50">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto transform transition-all p-6">
      <div class="flex justify-between items-start border-b pb-3 mb-4">
        <h3 class="text-xl font-bold text-gray-900" id="detail_modal_title">æ•¸æ“šè©³æƒ…</h3>
        <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 transition duration-150">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
        </button>
      </div>
      <pre id="detail_content" class="bg-gray-100 p-4 rounded-lg text-sm whitespace-pre-wrap break-words overflow-x-auto"></pre>
    </div>
  </div>

  <script>
    // âœ… è‡ªå‹•åµæ¸¬ API ä¼ºæœå™¨
    const API_BASE = (() => {
      const host = window.location.hostname;
      if (host.includes("localhost")) return "http://localhost:3000";
      return "https://mindtest-backend.onrender.com";
    })();

    let currentEvents = [], currentResults = [], activeTab = "events";

    // âœ… å…±ç”¨ fetch å‡½æ•¸
    async function fetchAPI(endpoint) {
      try {
        const res = await fetch(`${API_BASE}${endpoint}`);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        return await res.json();
      } catch (err) {
        console.error("âŒ Fetch Error:", err);
        showError(`è¼‰å…¥æ•¸æ“šå¤±æ•—ï¼š${err.message}`);
        throw err;
      }
    }

    // âœ… é¡¯ç¤ºéŒ¯èª¤
    function showError(message) {
      const msg = document.getElementById("error_message");
      msg.classList.remove("hidden");
      msg.innerHTML = `<p><strong>éŒ¯èª¤ï¼š</strong> ${message}</p>`;
    }

    // âœ… è¼‰å…¥äº‹ä»¶è³‡æ–™
    async function loadEvents() {
      const start = document.getElementById("date_start").value;
      const end = document.getElementById("date_end").value;
      let query = `?pageSize=500`;
      if (start) query += `&start=${start}`;
      if (end) query += `&end=${end}`;
      document.getElementById("event_loading_status").textContent = "è¼‰å…¥ä¸­...";

      const data = await fetchAPI(`/api/events${query}`).catch(() => []);
      currentEvents = Array.isArray(data) ? data : [];
      renderEvents(currentEvents);
      document.getElementById("event_loading_status").textContent = `æˆåŠŸè¼‰å…¥ ${currentEvents.length} æ¢è¨˜éŒ„ã€‚`;
    }

    // âœ… è¼‰å…¥æ¸¬é©—çµæœ
    async function loadResults() {
      const start = document.getElementById("date_start").value;
      const end = document.getElementById("date_end").value;
      let query = `?pageSize=500`;
      if (start) query += `&start=${start}`;
      if (end) query += `&end=${end}`;
      document.getElementById("result_loading_status").textContent = "è¼‰å…¥ä¸­...";

      const data = await fetchAPI(`/api/results${query}`).catch(() => []);
      currentResults = Array.isArray(data) ? data : [];
      renderResults(currentResults);
      document.getElementById("result_loading_status").textContent = `æˆåŠŸè¼‰å…¥ ${currentResults.length} æ¢è¨˜éŒ„ã€‚`;
    }

    // âœ… æ™‚é–“æ ¼å¼åŒ–
    function formatTimestamp(ts) {
      return ts ? new Date(ts).toLocaleString("zh-TW", {
        year: "numeric", month: "2-digit", day: "2-digit",
        hour: "2-digit", minute: "2-digit", second: "2-digit",
        hour12: false
      }) : "N/A";
    }

    // âœ… Render Events
    function renderEvents(data) {
      const tbody = document.getElementById("event_data_body");
      tbody.innerHTML = "";
      if (!data.length) {
        tbody.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-gray-500">æ²’æœ‰æ‰¾åˆ°ä»»ä½•äº‹ä»¶è¨˜éŒ„ã€‚</td></tr>`;
        return;
      }
      data.forEach(item => {
        const row = tbody.insertRow();
        row.className = "hover:bg-amber-50 transition duration-150";
        row.onclick = () => showDetail(item, "äº‹ä»¶è©³æƒ…");
        row.insertCell().textContent = formatTimestamp(item.timestamp);
        row.insertCell().textContent = item.event_name;
        row.insertCell().textContent = item.session_id;
        row.insertCell().textContent = item.user_id || "N/A";
        row.insertCell().textContent = item.page || "N/A";
      });
    }

    // âœ… Render Results
    function renderResults(data) {
      const tbody = document.getElementById("result_data_body");
      tbody.innerHTML = "";
      if (!data.length) {
        tbody.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-gray-500">æ²’æœ‰æ‰¾åˆ°ä»»ä½•æ¸¬é©—çµæœã€‚</td></tr>`;
        return;
      }
      data.forEach(item => {
        const row = tbody.insertRow();
        row.className = "hover:bg-amber-50 transition duration-150";
        row.onclick = () => showDetail(item, "æ¸¬é©—çµæœè©³æƒ…");
        row.insertCell().textContent = formatTimestamp(item.timestamp);
        row.insertCell().textContent = item.session_id;
        row.insertCell().textContent = item.result;
        row.insertCell().textContent = JSON.stringify(item.scores);
      });
    }

    // âœ… Modal æ§åˆ¶
    function showDetail(item, title) {
      document.getElementById("detail_modal_title").textContent = title;
      document.getElementById("detail_content").textContent = JSON.stringify(item, null, 2);
      document.getElementById("detail_modal").classList.add("open");
    }
    function closeModal() {
      document.getElementById("detail_modal").classList.remove("open");
    }

    // âœ… Tab åˆ‡æ›
    function showTab(tab) {
      activeTab = tab;
      document.querySelectorAll(".tab-content").forEach(el => el.classList.remove("active"));
      document.querySelectorAll(".tab-button").forEach(btn => btn.classList.remove("active", "bg-amber-500", "text-white"));
      document.getElementById(`content_${tab}`).classList.add("active");
      const activeBtn = document.getElementById(`tab_${tab}`);
      activeBtn.classList.add("active", "bg-amber-500", "text-white");
      applyFilters();
    }

    // âœ… ç¯©é¸å™¨å¥—ç”¨
    function applyFilters() {
      if (activeTab === "events") loadEvents();
      else loadResults();
    }

    // âœ… åˆå§‹åŒ–
    document.addEventListener("DOMContentLoaded", () => showTab("events"));
  </script>
</body>
</html>
