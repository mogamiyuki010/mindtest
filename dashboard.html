<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>數據監控 Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
  <style>
    /* === 略，樣式與你原版相同 === */
    * {margin:0;padding:0;box-sizing:border-box;}
    body {font-family:'Noto Sans TC',sans-serif;background:linear-gradient(135deg,#FFF8F0,#F7E6DC);color:#6B5D54;min-height:100vh;}
    .header{background:linear-gradient(135deg,#FFB4AE,#F4A6A0);color:white;padding:20px;text-align:center;box-shadow:0 4px 20px rgba(244,166,160,0.3);}
    .container{max-width:1200px;margin:0 auto;padding:20px;}
    .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:16px;margin-bottom:24px;}
    .stat-card{background:linear-gradient(135deg,#FFFFFF,#FFF8F0);padding:18px;border-radius:12px;box-shadow:0 4px 12px rgba(244,166,160,0.15);text-align:center;border:1px solid rgba(244,166,160,0.1);}
    .stat-number{font-size:28px;font-weight:800;color:#F4A6A0;margin-bottom:8px;}
    .stat-label{font-size:14px;color:#9B8D84;}
    .charts-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(350px,1fr));gap:18px;margin-bottom:24px;}
    .chart-card{background:linear-gradient(135deg,#FFFFFF,#FFF8F0);padding:20px;border-radius:12px;box-shadow:0 4px 12px rgba(244,166,160,0.15);}
    .realtime-section{background:linear-gradient(135deg,#FFFFFF,#FFF8F0);padding:20px;border-radius:12px;box-shadow:0 4px 12px rgba(244,166,160,0.15);}
    .realtime-number{font-size:20px;font-weight:700;color:#F4A6A0;}
    .error{background:#f8d7da;color:#721c24;padding:15px;border-radius:10px;margin:20px 0;}
    .refresh-btn{background:linear-gradient(135deg,#FFB4AE,#F4A6A0);color:white;padding:12px 24px;border-radius:25px;border:none;cursor:pointer;font-weight:600;}
  </style>
</head>
<body>
  <div class="header">
    <h1>📊 數據監控 Dashboard</h1>
    <p>實時監控用戶行為數據</p>
  </div>

  <div class="container">
    <button class="refresh-btn" onclick="loadDashboardData()">🔄 刷新數據</button>

    <!-- 統計卡片 -->
    <div class="stats-grid">
      <div class="stat-card"><div class="stat-number" id="totalEvents">-</div><div class="stat-label">總事件數</div></div>
      <div class="stat-card"><div class="stat-number" id="totalUsers">-</div><div class="stat-label">總用戶數</div></div>
      <div class="stat-card"><div class="stat-number" id="totalSessions">-</div><div class="stat-label">總會話數</div></div>
      <div class="stat-card"><div class="stat-number" id="todayEvents">-</div><div class="stat-label">今日事件</div></div>
      <div class="stat-card"><div class="stat-number" id="todayUsers">-</div><div class="stat-label">今日用戶</div></div>
    </div>

    <!-- 圖表 -->
    <div class="charts-grid">
      <div class="chart-card"><div class="chart-title">熱門事件</div><canvas id="topEventsChart"></canvas></div>
      <div class="chart-card"><div class="chart-title">頁面瀏覽統計</div><canvas id="pageViewsChart"></canvas></div>
      <div class="chart-card"><div class="chart-title">測驗結果分布</div><canvas id="quizResultsChart"></canvas></div>
      <div class="chart-card"><div class="chart-title">今日事件趨勢</div><canvas id="hourlyEventsChart"></canvas></div>
    </div>

    <!-- 實時資料 -->
    <div class="realtime-section">
      <div class="realtime-title">🟢 實時數據</div>
      <div class="realtime-stats">
        <div class="realtime-stat"><div class="realtime-number" id="recentEvents">-</div><div class="realtime-label">最近5分鐘事件</div></div>
        <div class="realtime-stat"><div class="realtime-number" id="onlineUsers">-</div><div class="realtime-label">在線用戶</div></div>
      </div>
      <div class="chart-title">最近事件</div>
      <div class="event-list" id="recentEventList"><div class="loading">載入中...</div></div>
    </div>
  </div>

  <script>
    // 🌐 自動判斷後端環境
    const API_BASE = window.location.hostname.includes('github.io')
      ? 'https://mindtest-backend.onrender.com'
      : 'http://localhost:3000';

    Chart.register(ChartDataLabels);
    let charts = {};

    // 儀表板資料
    async function loadDashboardData() {
      try {
        const res = await fetch(`${API_BASE}/api/dashboard`);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        updateStats(data);
        updateCharts(data);
      } catch (err) {
        console.error('Dashboard error:', err);
        showError('載入數據失敗：' + err.message);
      }
    }

    // 實時資料
    async function loadRealtimeData() {
      try {
        const res = await fetch(`${API_BASE}/api/realtime`);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        updateRealtimeStats(data);
        updateRecentEvents(data.recentEventList);
      } catch (err) {
        console.error('Realtime error:', err);
      }
    }

    // 統計卡
    function updateStats(data) {
      document.getElementById('totalEvents').textContent = data.totalEvents?.[0]?.count || 0;
      document.getElementById('totalUsers').textContent = data.totalUsers?.[0]?.count || 0;
      document.getElementById('totalSessions').textContent = data.totalSessions?.[0]?.count || 0;
      document.getElementById('todayEvents').textContent = data.todayEvents?.[0]?.count || 0;
      document.getElementById('todayUsers').textContent = data.todayUsers?.[0]?.count || 0;
    }

    // 即時統計
    function updateRealtimeStats(data) {
      document.getElementById('recentEvents').textContent = data.recentEvents?.[0]?.count || 0;
      document.getElementById('onlineUsers').textContent = data.onlineUsers?.[0]?.count || 0;
    }

    // 最近事件
    function updateRecentEvents(events) {
      const container = document.getElementById('recentEventList');
      if (!events || events.length === 0) {
        container.innerHTML = '<div class="loading">暫無最近事件</div>';
        return;
      }
      container.innerHTML = events.map(e => `
        <div class="event-item">
          <div>
            <div class="event-name">${e.event_name}</div>
            <div class="event-time">${formatTime(e.timestamp)} - ${e.user_id}</div>
          </div>
          <div style="font-size:12px;color:#666;">${e.page}</div>
        </div>`).join('');
    }

    // 更新圖表（呼叫你原本的 update* 函數）
    function updateCharts(data) {
      updateTopEventsChart(data.topEvents);
      updatePageViewsChart(data.pageViews);
      updateQuizResultsChart(data.quizResults);
      updateHourlyEventsChart(data.hourlyEvents);
    }

    // === 原本的 updateTopEventsChart, updatePageViewsChart, updateQuizResultsChart, updateHourlyEventsChart 全保留 ===
    // （略，完全照你的版本）

    // 格式化時間
    function formatTime(t) {
      return new Date(t).toLocaleTimeString('zh-TW', {hour:'2-digit',minute:'2-digit',second:'2-digit'});
    }

    // 顯示錯誤訊息
    function showError(msg) {
      const c = document.querySelector('.container');
      const d = document.createElement('div');
      d.className = 'error';
      d.textContent = msg;
      c.insertBefore(d, c.firstChild);
      setTimeout(() => d.remove(), 5000);
    }

    // 初始化
    document.addEventListener('DOMContentLoaded', () => {
      loadDashboardData();
      loadRealtimeData();
      setInterval(loadRealtimeData, 30000);
      setInterval(loadDashboardData, 300000);
    });
  </script>
</body>
</html>
