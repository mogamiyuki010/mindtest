<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>📊 測驗分析管理後台 (Admin Dashboard)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: 'Inter', sans-serif; background-color: #f7fafc; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .tab-button.active { background-color: #f59e0b; color: white; }
    .data-table th, .data-table td { padding: 0.75rem; border-bottom: 1px solid #e2e8f0; }
    .data-table th { text-align: left; background-color: #edf2f7; }
    .data-table tr:hover { cursor: pointer; }
    .modal { transition: opacity 0.3s ease-in-out; visibility: hidden; opacity: 0; }
    .modal.open { visibility: visible; opacity: 1; }
  </style>
</head>

<body class="p-6">
  <div class="max-w-7xl mx-auto bg-white rounded-xl shadow-2xl p-8">
    <h1 class="text-3xl font-bold text-gray-900 mb-6 border-b-4 border-amber-500 pb-2">
      📊 測驗數據分析儀表板
    </h1>

    <div class="flex flex-wrap gap-4 items-center mb-6 p-4 bg-amber-50 rounded-lg shadow-inner">
      <div class="flex-grow">
        <label for="date_start" class="block text-sm font-medium text-gray-700">起始日期</label>
        <input type="date" id="date_start" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
      </div>
      <div class="flex-grow">
        <label for="date_end" class="block text-sm font-medium text-gray-700">結束日期</label>
        <input type="date" id="date_end" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
      </div>
      <button onclick="applyFilters()" class="mt-4 px-6 py-2 bg-amber-500 text-white font-semibold rounded-lg shadow-md hover:bg-amber-600 transition duration-150">
        套用篩選
      </button>
    </div>

    <!-- Tabs -->
    <div class="flex space-x-2 border-b border-gray-200 mb-6">
      <button id="tab_events" class="tab-button active px-4 py-2 text-sm font-medium rounded-t-lg bg-amber-500 text-white transition duration-150" onclick="showTab('events')">事件記錄 (Events)</button>
      <button id="tab_results" class="tab-button px-4 py-2 text-sm font-medium rounded-t-lg text-gray-700 hover:bg-gray-100 transition duration-150" onclick="showTab('results')">測驗結果 (Results)</button>
    </div>

    <!-- Events -->
    <div id="content_events" class="tab-content active">
      <h2 class="text-xl font-semibold mb-4 text-gray-800">所有事件記錄</h2>
      <p id="event_loading_status" class="text-sm text-gray-500 mb-4">載入中...</p>
      <div class="overflow-x-auto rounded-lg shadow-md">
        <table class="data-table min-w-full divide-y divide-gray-200">
          <thead>
            <tr>
              <th class="py-3 px-4 text-sm font-semibold uppercase tracking-wider">時間戳</th>
              <th class="py-3 px-4 text-sm font-semibold uppercase tracking-wider">事件名稱</th>
              <th class="py-3 px-4 text-sm font-semibold uppercase tracking-wider">會話 ID</th>
              <th class="py-3 px-4 text-sm font-semibold uppercase tracking-wider">用戶 ID</th>
              <th class="py-3 px-4 text-sm font-semibold uppercase tracking-wider">頁面</th>
            </tr>
          </thead>
          <tbody id="event_data_body" class="bg-white divide-y divide-gray-200"></tbody>
        </table>
      </div>
    </div>

    <!-- Results -->
    <div id="content_results" class="tab-content">
      <h2 class="text-xl font-semibold mb-4 text-gray-800">所有測驗結果</h2>
      <p id="result_loading_status" class="text-sm text-gray-500 mb-4">載入中...</p>
      <div class="overflow-x-auto rounded-lg shadow-md">
        <table class="data-table min-w-full divide-y divide-gray-200">
          <thead>
            <tr>
              <th class="py-3 px-4 text-sm font-semibold uppercase tracking-wider">時間戳</th>
              <th class="py-3 px-4 text-sm font-semibold uppercase tracking-wider">會話 ID</th>
              <th class="py-3 px-4 text-sm font-semibold uppercase tracking-wider">測驗結果名</th>
              <th class="py-3 px-4 text-sm font-semibold uppercase tracking-wider">分數詳情</th>
            </tr>
          </thead>
          <tbody id="result_data_body" class="bg-white divide-y divide-gray-200"></tbody>
        </table>
      </div>
    </div>

    <!-- Error -->
    <div id="error_message" class="hidden mt-6 p-4 text-sm text-red-700 bg-red-100 rounded-lg" role="alert">
      <p><strong>錯誤：</strong> 無法從後端載入數據。請確認伺服器是否啟動。</p>
    </div>
  </div>

  <!-- Modal -->
  <div id="detail_modal" class="modal fixed inset-0 z-50 flex items-center justify-center p-4 bg-gray-900 bg-opacity-50">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto transform transition-all p-6">
      <div class="flex justify-between items-start border-b pb-3 mb-4">
        <h3 class="text-xl font-bold text-gray-900" id="detail_modal_title">數據詳情</h3>
        <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 transition duration-150">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
        </button>
      </div>
      <pre id="detail_content" class="bg-gray-100 p-4 rounded-lg text-sm whitespace-pre-wrap break-words overflow-x-auto"></pre>
    </div>
  </div>

  <script>
    // ✅ 自動偵測 API 伺服器
    const API_BASE = (() => {
      const host = window.location.hostname;
      if (host.includes("localhost")) return "http://localhost:3000";
      return "https://mindtest-backend.onrender.com";
    })();

    let currentEvents = [], currentResults = [], activeTab = "events";

    // ✅ 共用 fetch 函數
    async function fetchAPI(endpoint) {
      try {
        const res = await fetch(`${API_BASE}${endpoint}`);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        return await res.json();
      } catch (err) {
        console.error("❌ Fetch Error:", err);
        showError(`載入數據失敗：${err.message}`);
        throw err;
      }
    }

    // ✅ 顯示錯誤
    function showError(message) {
      const msg = document.getElementById("error_message");
      msg.classList.remove("hidden");
      msg.innerHTML = `<p><strong>錯誤：</strong> ${message}</p>`;
    }

    // ✅ 載入事件資料
    async function loadEvents() {
      const start = document.getElementById("date_start").value;
      const end = document.getElementById("date_end").value;
      let query = `?pageSize=500`;
      if (start) query += `&start=${start}`;
      if (end) query += `&end=${end}`;
      document.getElementById("event_loading_status").textContent = "載入中...";

      const data = await fetchAPI(`/api/events${query}`).catch(() => []);
      currentEvents = Array.isArray(data) ? data : [];
      renderEvents(currentEvents);
      document.getElementById("event_loading_status").textContent = `成功載入 ${currentEvents.length} 條記錄。`;
    }

    // ✅ 載入測驗結果
    async function loadResults() {
      const start = document.getElementById("date_start").value;
      const end = document.getElementById("date_end").value;
      let query = `?pageSize=500`;
      if (start) query += `&start=${start}`;
      if (end) query += `&end=${end}`;
      document.getElementById("result_loading_status").textContent = "載入中...";

      const data = await fetchAPI(`/api/results${query}`).catch(() => []);
      currentResults = Array.isArray(data) ? data : [];
      renderResults(currentResults);
      document.getElementById("result_loading_status").textContent = `成功載入 ${currentResults.length} 條記錄。`;
    }

    // ✅ 時間格式化
    function formatTimestamp(ts) {
      return ts ? new Date(ts).toLocaleString("zh-TW", {
        year: "numeric", month: "2-digit", day: "2-digit",
        hour: "2-digit", minute: "2-digit", second: "2-digit",
        hour12: false
      }) : "N/A";
    }

    // ✅ Render Events
    function renderEvents(data) {
      const tbody = document.getElementById("event_data_body");
      tbody.innerHTML = "";
      if (!data.length) {
        tbody.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-gray-500">沒有找到任何事件記錄。</td></tr>`;
        return;
      }
      data.forEach(item => {
        const row = tbody.insertRow();
        row.className = "hover:bg-amber-50 transition duration-150";
        row.onclick = () => showDetail(item, "事件詳情");
        row.insertCell().textContent = formatTimestamp(item.timestamp);
        row.insertCell().textContent = item.event_name;
        row.insertCell().textContent = item.session_id;
        row.insertCell().textContent = item.user_id || "N/A";
        row.insertCell().textContent = item.page || "N/A";
      });
    }

    // ✅ Render Results
    function renderResults(data) {
      const tbody = document.getElementById("result_data_body");
      tbody.innerHTML = "";
      if (!data.length) {
        tbody.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-gray-500">沒有找到任何測驗結果。</td></tr>`;
        return;
      }
      data.forEach(item => {
        const row = tbody.insertRow();
        row.className = "hover:bg-amber-50 transition duration-150";
        row.onclick = () => showDetail(item, "測驗結果詳情");
        row.insertCell().textContent = formatTimestamp(item.timestamp);
        row.insertCell().textContent = item.session_id;
        row.insertCell().textContent = item.result;
        row.insertCell().textContent = JSON.stringify(item.scores);
      });
    }

    // ✅ Modal 控制
    function showDetail(item, title) {
      document.getElementById("detail_modal_title").textContent = title;
      document.getElementById("detail_content").textContent = JSON.stringify(item, null, 2);
      document.getElementById("detail_modal").classList.add("open");
    }
    function closeModal() {
      document.getElementById("detail_modal").classList.remove("open");
    }

    // ✅ Tab 切換
    function showTab(tab) {
      activeTab = tab;
      document.querySelectorAll(".tab-content").forEach(el => el.classList.remove("active"));
      document.querySelectorAll(".tab-button").forEach(btn => btn.classList.remove("active", "bg-amber-500", "text-white"));
      document.getElementById(`content_${tab}`).classList.add("active");
      const activeBtn = document.getElementById(`tab_${tab}`);
      activeBtn.classList.add("active", "bg-amber-500", "text-white");
      applyFilters();
    }

    // ✅ 篩選器套用
    function applyFilters() {
      if (activeTab === "events") loadEvents();
      else loadResults();
    }

    // ✅ 初始化
    document.addEventListener("DOMContentLoaded", () => showTab("events"));
  </script>
</body>
</html>
