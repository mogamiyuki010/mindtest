<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ“Š æ¸¬é©—åˆ†æç®¡ç†å¾Œå° (Admin Dashboard)</title>
    <!-- ä½¿ç”¨ Tailwind CDN å¿«é€Ÿç¾åŒ–ä»‹é¢ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="./config.js"></script>
    <style>
        /* è‡ªå®šç¾©æ¨£å¼ */
        body { font-family: 'Inter', sans-serif; background-color: #f7fafc; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        /* æš–è‰²ç³»ï¼šä¸»è¦æŒ‰éˆ•å’Œ active tab é¡è‰²æ”¹ç‚ºç¥ç€è‰² (Amber-500) */
        .tab-button.active { background-color: #f59e0b; color: white; } 
        .data-table th, .data-table td { padding: 0.75rem; border-bottom: 1px solid #e2e8f0; }
        .data-table th { text-align: left; background-color: #edf2f7; }
        .data-table tr:hover { cursor: pointer; } 
        .modal {
            transition: opacity 0.3s ease-in-out;
            visibility: hidden;
            opacity: 0;
        }
        .modal.open {
            visibility: visible;
            opacity: 1;
        }
    </style>
</head>
<body class="p-6">

    <div class="max-w-7xl mx-auto bg-white rounded-xl shadow-2xl p-8">
        <!-- å­—é«”å„ªåŒ–ï¼šH1 å°ºå¯¸ç‚º text-3xlï¼Œä¸¦æ›´æ›ç‚ºæš–è‰²é‚Šæ¡† -->
        <h1 class="text-3xl font-bold text-gray-900 mb-6 border-b-4 border-amber-500 pb-2">
            ğŸ“Š æ¸¬é©—æ•¸æ“šåˆ†æå„€è¡¨æ¿
        </h1>

        <!-- æš–è‰²ç³»ï¼šæ•¸æ“šç¯©é¸å€åº•è‰²æ”¹ç‚º bg-amber-50 -->
        <div class="flex flex-wrap gap-4 items-center mb-6 p-4 bg-amber-50 rounded-lg shadow-inner">
            <div class="flex-grow">
                <label for="date_start" class="block text-sm font-medium text-gray-700">èµ·å§‹æ—¥æœŸ</label>
                <input type="date" id="date_start" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
            </div>
            <div class="flex-grow">
                <label for="date_end" class="block text-sm font-medium text-gray-700">çµæŸæ—¥æœŸ</label>
                <input type="date" id="date_end" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
            </div>
            <!-- æš–è‰²ç³»ï¼šæŒ‰éˆ•é¡è‰²æ”¹ç‚º bg-amber-500/hover:bg-amber-600 -->
            <button onclick="applyFilters()" class="mt-4 px-6 py-2 bg-amber-500 text-white font-semibold rounded-lg shadow-md hover:bg-amber-600 transition duration-150">
                å¥—ç”¨ç¯©é¸
            </button>
        </div>

        <!-- å°èˆªæ¨™ç±¤ (Tabs) -->
        <div class="flex space-x-2 border-b border-gray-200 mb-6">
            <!-- æš–è‰²ç³»ï¼šActive Tab é¡è‰²æ”¹ç‚º bg-amber-500 -->
            <button id="tab_events" class="tab-button active px-4 py-2 text-sm font-medium rounded-t-lg bg-amber-500 text-white transition duration-150" onclick="showTab('events')">äº‹ä»¶è¨˜éŒ„ (Events)</button>
            <button id="tab_results" class="tab-button px-4 py-2 text-sm font-medium rounded-t-lg text-gray-700 hover:bg-gray-100 transition duration-150" onclick="showTab('results')">æ¸¬é©—çµæœ (Results)</button>
        </div>

        <!-- å…§å®¹å€åŸŸ (Events) -->
        <div id="content_events" class="tab-content active">
            <!-- å­—é«”å„ªåŒ–ï¼šH2 å°ºå¯¸ç‚º text-xl -->
            <h2 class="text-xl font-semibold mb-4 text-gray-800">æ‰€æœ‰äº‹ä»¶è¨˜éŒ„</h2>
            <p id="event_loading_status" class="text-sm text-gray-500 mb-4">è¼‰å…¥ä¸­...</p>
            <div class="overflow-x-auto rounded-lg shadow-md">
                <table class="data-table min-w-full divide-y divide-gray-200">
                    <thead>
                        <tr>
                            <!-- å­—é«”å„ªåŒ–ï¼šè¡¨é ­å­—é«”ç‚º text-smï¼Œèˆ‡å…§å®¹ä¿æŒä¸€è‡´ -->
                            <th class="py-3 px-4 text-sm font-semibold uppercase tracking-wider">æ™‚é–“æˆ³</th>
                            <th class="py-3 px-4 text-sm font-semibold uppercase tracking-wider">äº‹ä»¶åç¨±</th>
                            <th class="py-3 px-4 text-sm font-semibold uppercase tracking-wider">æœƒè©± ID</th>
                            <th class="py-3 px-4 text-sm font-semibold uppercase tracking-wider">ç”¨æˆ¶ ID</th>
                            <th class="py-3 px-4 text-sm font-semibold uppercase tracking-wider">é é¢</th>
                        </tr>
                    </thead>
                    <tbody id="event_data_body" class="bg-white divide-y divide-gray-200">
                        <!-- æ•¸æ“šå°‡ç”± JS å¡«å…… -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- å…§å®¹å€åŸŸ (Results) -->
        <div id="content_results" class="tab-content">
            <!-- å­—é«”å„ªåŒ–ï¼šH2 å°ºå¯¸ç‚º text-xl -->
            <h2 class="text-xl font-semibold mb-4 text-gray-800">æ‰€æœ‰æ¸¬é©—çµæœ</h2>
            <p id="result_loading_status" class="text-sm text-gray-500 mb-4">è¼‰å…¥ä¸­...</p>
            <div class="overflow-x-auto rounded-lg shadow-md">
                <table class="data-table min-w-full divide-y divide-gray-200">
                    <thead>
                        <tr>
                            <!-- å­—é«”å„ªåŒ–ï¼šè¡¨é ­å­—é«”ç‚º text-smï¼Œèˆ‡å…§å®¹ä¿æŒä¸€è‡´ -->
                            <th class="py-3 px-4 text-sm font-semibold uppercase tracking-wider">æ™‚é–“æˆ³</th>
                            <th class="py-3 px-4 text-sm font-semibold uppercase tracking-wider">æœƒè©± ID</th>
                            <th class="py-3 px-4 text-sm font-semibold uppercase tracking-wider">æ¸¬é©—çµæœå</th>
                            <th class="py-3 px-4 text-sm font-semibold uppercase tracking-wider">åˆ†æ•¸è©³æƒ…</th>
                        </tr>
                    </thead>
                    <tbody id="result_data_body" class="bg-white divide-y divide-gray-200">
                        <!-- æ•¸æ“šå°‡ç”± JS å¡«å…… -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- æ•¸æ“šè¼‰å…¥éŒ¯èª¤æç¤º -->
        <div id="error_message" class="hidden mt-6 p-4 text-sm text-red-700 bg-red-100 rounded-lg" role="alert">
            <p><strong>éŒ¯èª¤ï¼š</strong> ç„¡æ³•å¾å¾Œç«¯è¼‰å…¥æ•¸æ“šã€‚è«‹ç¢ºèªæ‚¨çš„ Node.js ä¼ºæœå™¨æ˜¯å¦å·²æˆåŠŸé‹è¡Œ (ä¾‹å¦‚: `node server.js`)ã€‚</p>
        </div>
    </div>

    <!-- Modal for Detail View -->
    <div id="detail_modal" class="modal fixed inset-0 z-50 flex items-center justify-center p-4 bg-gray-900 bg-opacity-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto transform transition-all p-6">
            <div class="flex justify-between items-start border-b pb-3 mb-4">
                <h3 class="text-xl font-bold text-gray-900" id="detail_modal_title">æ•¸æ“šè©³æƒ…</h3>
                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 transition duration-150">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <pre id="detail_content" class="bg-gray-100 p-4 rounded-lg text-sm whitespace-pre-wrap break-words overflow-x-auto"></pre>
        </div>
    </div>

    <script>
        // ç¢ºä¿è®Šæ•¸èƒ½åœ¨å…¨å±€è¨ªå•ï¼Œç”¨æ–¼å„²å­˜ç•¶å‰æ•¸æ“š
        let currentEvents = [];
        let currentResults = [];
        let activeTab = 'events';

        // è¼”åŠ©å‡½æ•¸ï¼šå°‡ ISO æ™‚é–“å­—ä¸²è½‰æ›ç‚ºå¯è®€æ ¼å¼
        function formatTimestamp(isoString) {
            if (!isoString) return 'N/A';
            return new Date(isoString).toLocaleString('zh-TW', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            });
        }

        // è¼‰å…¥äº‹ä»¶æ•¸æ“š (GET /api/events)
        async function loadEvents() {
            const startDate = document.getElementById('date_start').value;
            const endDate = document.getElementById('date_end').value;
            // é—œéµï¼šä½¿ç”¨å‹•æ…‹ API ç«¯é»
            let url = window.API_CONFIG.getEndpoint('/api/events?pageSize=500'); 

            if (startDate) url += `&start=${startDate}`;
            if (endDate) url += `&end=${endDate}`;

            document.getElementById('event_loading_status').textContent = 'è¼‰å…¥ä¸­...';
            document.getElementById('error_message').classList.add('hidden');
            
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                
                const data = await response.json();
                currentEvents = data;
                renderEvents(data);
                document.getElementById('event_loading_status').textContent = `æˆåŠŸè¼‰å…¥ ${data.length} æ¢è¨˜éŒ„ã€‚`;
            } catch (error) {
                console.error('Fetch Events Error:', error);
                document.getElementById('event_loading_status').textContent = 'è¼‰å…¥å¤±æ•—ã€‚';
                document.getElementById('error_message').classList.remove('hidden');
            }
        }

        // æ¸²æŸ“äº‹ä»¶è¡¨æ ¼
        function renderEvents(data) {
            const tbody = document.getElementById('event_data_body');
            tbody.innerHTML = '';
            
            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-gray-500">æ²’æœ‰æ‰¾åˆ°ä»»ä½•äº‹ä»¶è¨˜éŒ„ã€‚</td></tr>';
                return;
            }

            data.forEach((item, index) => {
                const row = tbody.insertRow();
                // æš–è‰²ç³»ï¼šè¡¨æ ¼ hover é¡è‰²
                row.className = 'hover:bg-amber-50 transition duration-150'; 
                row.onclick = () => showDetail(item, 'äº‹ä»¶è©³æƒ…');

                // æ™‚é–“æˆ³
                row.insertCell().textContent = formatTimestamp(item.timestamp);
                // äº‹ä»¶åç¨±
                row.insertCell().textContent = item.event_name;
                // æœƒè©± ID
                row.insertCell().textContent = item.session_id;
                // ç”¨æˆ¶ ID (é€™è£¡ä½¿ç”¨ session_id)
                row.insertCell().textContent = item.user_id; 
                // é é¢
                row.insertCell().textContent = item.page || 'N/A';
            });
        }

        // è¼‰å…¥æ¸¬é©—çµæœæ•¸æ“š (GET /api/results)
        async function loadResults() {
            const startDate = document.getElementById('date_start').value;
            const endDate = document.getElementById('date_end').value;
            // é—œéµï¼šä½¿ç”¨å‹•æ…‹ API ç«¯é»
            let url = window.API_CONFIG.getEndpoint('/api/results?pageSize=500');

            if (startDate) url += `&start=${startDate}`;
            if (endDate) url += `&end=${endDate}`;

            document.getElementById('result_loading_status').textContent = 'è¼‰å…¥ä¸­...';
            document.getElementById('error_message').classList.add('hidden');

            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                
                const data = await response.json();
                currentResults = data;
                renderResults(data);
                document.getElementById('result_loading_status').textContent = `æˆåŠŸè¼‰å…¥ ${data.length} æ¢è¨˜éŒ„ã€‚`;
            } catch (error) {
                console.error('Fetch Results Error:', error);
                document.getElementById('result_loading_status').textContent = 'è¼‰å…¥å¤±æ•—ã€‚';
                document.getElementById('error_message').classList.remove('hidden');
            }
        }

        // æ¸²æŸ“æ¸¬é©—çµæœè¡¨æ ¼
        function renderResults(data) {
            const tbody = document.getElementById('result_data_body');
            tbody.innerHTML = '';

            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-gray-500">æ²’æœ‰æ‰¾åˆ°ä»»ä½•æ¸¬é©—çµæœã€‚</td></tr>';
                return;
            }

            data.forEach((item, index) => {
                const row = tbody.insertRow();
                // æš–è‰²ç³»ï¼šè¡¨æ ¼ hover é¡è‰²
                row.className = 'hover:bg-amber-50 transition duration-150';
                row.onclick = () => showDetail(item, 'æ¸¬é©—çµæœè©³æƒ…');

                // æ™‚é–“æˆ³
                row.insertCell().textContent = formatTimestamp(item.timestamp);
                // æœƒè©± ID
                row.insertCell().textContent = item.session_id;
                // æ¸¬é©—çµæœå
                row.insertCell().textContent = item.result;
                // åˆ†æ•¸è©³æƒ… (é¡¯ç¤º JSON æ ¼å¼ï¼Œå› ç‚ºå¾Œç«¯å·²è§£ææˆç‰©ä»¶)
                row.insertCell().textContent = JSON.stringify(item.scores);
            });
        }

        // é¡¯ç¤ºè©³æƒ… Modal
        function showDetail(item, title) {
            document.getElementById('detail_modal_title').textContent = title;
            // æ ¼å¼åŒ– JSON æ•¸æ“šä½¿å…¶æ›´æ˜“è®€
            const content = JSON.stringify(item, null, 2); 
            document.getElementById('detail_content').textContent = content;
            document.getElementById('detail_modal').classList.add('open');
        }

        // é—œé–‰ Modal
        function closeModal() {
            document.getElementById('detail_modal').classList.remove('open');
        }

        // è™•ç† Tab åˆ‡æ›
        function showTab(tabName) {
            activeTab = tabName;
            
            // éš±è—æ‰€æœ‰å…§å®¹
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            // ç§»é™¤æ‰€æœ‰æŒ‰éˆ•çš„ active æ¨£å¼
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active', 'bg-amber-500', 'text-white');
                button.classList.add('text-gray-700', 'hover:bg-gray-100');
            });

            // é¡¯ç¤ºç•¶å‰ Tab å…§å®¹ä¸¦è¨­ç½®æŒ‰éˆ•æ¨£å¼
            document.getElementById(`content_${tabName}`).classList.add('active');
            const activeBtn = document.getElementById(`tab_${tabName}`);
            activeBtn.classList.add('active', 'bg-amber-500', 'text-white');
            activeBtn.classList.remove('text-gray-700', 'hover:bg-gray-100');
            
            // é‡æ–°è¼‰å…¥æ•¸æ“š
            applyFilters();
        }

        // å¥—ç”¨ç¯©é¸å™¨
        function applyFilters() {
            if (activeTab === 'events') {
                loadEvents();
            } else if (activeTab === 'results') {
                loadResults();
            }
        }

        // åˆå§‹åŒ–ï¼šé è¨­è¼‰å…¥äº‹ä»¶
        document.addEventListener('DOMContentLoaded', () => {
            showTab('events');
        });
    </script>
</body>
</html>
