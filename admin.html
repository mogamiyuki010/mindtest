<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>📊 測驗分析管理後台 (Admin Dashboard)</title>
    <!-- 使用 Tailwind CDN 快速美化介面 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="./config.js"></script>
    <style>
        /* 自定義樣式 */
        body { font-family: 'Inter', sans-serif; background-color: #f7fafc; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        /* 暖色系：主要按鈕和 active tab 顏色改為琥珀色 (Amber-500) */
        .tab-button.active { background-color: #f59e0b; color: white; } 
        .data-table th, .data-table td { padding: 0.75rem; border-bottom: 1px solid #e2e8f0; }
        .data-table th { text-align: left; background-color: #edf2f7; }
        .data-table tr:hover { cursor: pointer; } 
        .modal {
            transition: opacity 0.3s ease-in-out;
            visibility: hidden;
            opacity: 0;
        }
        .modal.open {
            visibility: visible;
            opacity: 1;
        }
    </style>
</head>
<body class="p-6">

    <div class="max-w-7xl mx-auto bg-white rounded-xl shadow-2xl p-8">
        <!-- 字體優化：H1 尺寸為 text-3xl，並更換為暖色邊框 -->
        <h1 class="text-3xl font-bold text-gray-900 mb-6 border-b-4 border-amber-500 pb-2">
            📊 測驗數據分析儀表板
        </h1>

        <!-- 暖色系：數據篩選區底色改為 bg-amber-50 -->
        <div class="flex flex-wrap gap-4 items-center mb-6 p-4 bg-amber-50 rounded-lg shadow-inner">
            <div class="flex-grow">
                <label for="date_start" class="block text-sm font-medium text-gray-700">起始日期</label>
                <input type="date" id="date_start" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
            </div>
            <div class="flex-grow">
                <label for="date_end" class="block text-sm font-medium text-gray-700">結束日期</label>
                <input type="date" id="date_end" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
            </div>
            <!-- 暖色系：按鈕顏色改為 bg-amber-500/hover:bg-amber-600 -->
            <button onclick="applyFilters()" class="mt-4 px-6 py-2 bg-amber-500 text-white font-semibold rounded-lg shadow-md hover:bg-amber-600 transition duration-150">
                套用篩選
            </button>
        </div>

        <!-- 導航標籤 (Tabs) -->
        <div class="flex space-x-2 border-b border-gray-200 mb-6">
            <!-- 暖色系：Active Tab 顏色改為 bg-amber-500 -->
            <button id="tab_events" class="tab-button active px-4 py-2 text-sm font-medium rounded-t-lg bg-amber-500 text-white transition duration-150" onclick="showTab('events')">事件記錄 (Events)</button>
            <button id="tab_results" class="tab-button px-4 py-2 text-sm font-medium rounded-t-lg text-gray-700 hover:bg-gray-100 transition duration-150" onclick="showTab('results')">測驗結果 (Results)</button>
        </div>

        <!-- 內容區域 (Events) -->
        <div id="content_events" class="tab-content active">
            <!-- 字體優化：H2 尺寸為 text-xl -->
            <h2 class="text-xl font-semibold mb-4 text-gray-800">所有事件記錄</h2>
            <p id="event_loading_status" class="text-sm text-gray-500 mb-4">載入中...</p>
            <div class="overflow-x-auto rounded-lg shadow-md">
                <table class="data-table min-w-full divide-y divide-gray-200">
                    <thead>
                        <tr>
                            <!-- 字體優化：表頭字體為 text-sm，與內容保持一致 -->
                            <th class="py-3 px-4 text-sm font-semibold uppercase tracking-wider">時間戳</th>
                            <th class="py-3 px-4 text-sm font-semibold uppercase tracking-wider">事件名稱</th>
                            <th class="py-3 px-4 text-sm font-semibold uppercase tracking-wider">會話 ID</th>
                            <th class="py-3 px-4 text-sm font-semibold uppercase tracking-wider">用戶 ID</th>
                            <th class="py-3 px-4 text-sm font-semibold uppercase tracking-wider">頁面</th>
                        </tr>
                    </thead>
                    <tbody id="event_data_body" class="bg-white divide-y divide-gray-200">
                        <!-- 數據將由 JS 填充 -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 內容區域 (Results) -->
        <div id="content_results" class="tab-content">
            <!-- 字體優化：H2 尺寸為 text-xl -->
            <h2 class="text-xl font-semibold mb-4 text-gray-800">所有測驗結果</h2>
            <p id="result_loading_status" class="text-sm text-gray-500 mb-4">載入中...</p>
            <div class="overflow-x-auto rounded-lg shadow-md">
                <table class="data-table min-w-full divide-y divide-gray-200">
                    <thead>
                        <tr>
                            <!-- 字體優化：表頭字體為 text-sm，與內容保持一致 -->
                            <th class="py-3 px-4 text-sm font-semibold uppercase tracking-wider">時間戳</th>
                            <th class="py-3 px-4 text-sm font-semibold uppercase tracking-wider">會話 ID</th>
                            <th class="py-3 px-4 text-sm font-semibold uppercase tracking-wider">測驗結果名</th>
                            <th class="py-3 px-4 text-sm font-semibold uppercase tracking-wider">分數詳情</th>
                        </tr>
                    </thead>
                    <tbody id="result_data_body" class="bg-white divide-y divide-gray-200">
                        <!-- 數據將由 JS 填充 -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- 數據載入錯誤提示 -->
        <div id="error_message" class="hidden mt-6 p-4 text-sm text-red-700 bg-red-100 rounded-lg" role="alert">
            <p><strong>錯誤：</strong> 無法從後端載入數據。請確認您的 Node.js 伺服器是否已成功運行 (例如: `node server.js`)。</p>
        </div>
    </div>

    <!-- Modal for Detail View -->
    <div id="detail_modal" class="modal fixed inset-0 z-50 flex items-center justify-center p-4 bg-gray-900 bg-opacity-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto transform transition-all p-6">
            <div class="flex justify-between items-start border-b pb-3 mb-4">
                <h3 class="text-xl font-bold text-gray-900" id="detail_modal_title">數據詳情</h3>
                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 transition duration-150">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <pre id="detail_content" class="bg-gray-100 p-4 rounded-lg text-sm whitespace-pre-wrap break-words overflow-x-auto"></pre>
        </div>
    </div>

    <script>
        // 確保變數能在全局訪問，用於儲存當前數據
        let currentEvents = [];
        let currentResults = [];
        let activeTab = 'events';

        // 輔助函數：將 ISO 時間字串轉換為可讀格式
        function formatTimestamp(isoString) {
            if (!isoString) return 'N/A';
            return new Date(isoString).toLocaleString('zh-TW', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            });
        }

        // 載入事件數據 (GET /api/events)
        async function loadEvents() {
            const startDate = document.getElementById('date_start').value;
            const endDate = document.getElementById('date_end').value;
            // 關鍵：使用動態 API 端點
            let url = window.API_CONFIG.getEndpoint('/api/events?pageSize=500'); 

            if (startDate) url += `&start=${startDate}`;
            if (endDate) url += `&end=${endDate}`;

            document.getElementById('event_loading_status').textContent = '載入中...';
            document.getElementById('error_message').classList.add('hidden');
            
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                
                const data = await response.json();
                currentEvents = data;
                renderEvents(data);
                document.getElementById('event_loading_status').textContent = `成功載入 ${data.length} 條記錄。`;
            } catch (error) {
                console.error('Fetch Events Error:', error);
                document.getElementById('event_loading_status').textContent = '載入失敗。';
                document.getElementById('error_message').classList.remove('hidden');
            }
        }

        // 渲染事件表格
        function renderEvents(data) {
            const tbody = document.getElementById('event_data_body');
            tbody.innerHTML = '';
            
            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-gray-500">沒有找到任何事件記錄。</td></tr>';
                return;
            }

            data.forEach((item, index) => {
                const row = tbody.insertRow();
                // 暖色系：表格 hover 顏色
                row.className = 'hover:bg-amber-50 transition duration-150'; 
                row.onclick = () => showDetail(item, '事件詳情');

                // 時間戳
                row.insertCell().textContent = formatTimestamp(item.timestamp);
                // 事件名稱
                row.insertCell().textContent = item.event_name;
                // 會話 ID
                row.insertCell().textContent = item.session_id;
                // 用戶 ID (這裡使用 session_id)
                row.insertCell().textContent = item.user_id; 
                // 頁面
                row.insertCell().textContent = item.page || 'N/A';
            });
        }

        // 載入測驗結果數據 (GET /api/results)
        async function loadResults() {
            const startDate = document.getElementById('date_start').value;
            const endDate = document.getElementById('date_end').value;
            // 關鍵：使用動態 API 端點
            let url = window.API_CONFIG.getEndpoint('/api/results?pageSize=500');

            if (startDate) url += `&start=${startDate}`;
            if (endDate) url += `&end=${endDate}`;

            document.getElementById('result_loading_status').textContent = '載入中...';
            document.getElementById('error_message').classList.add('hidden');

            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                
                const data = await response.json();
                currentResults = data;
                renderResults(data);
                document.getElementById('result_loading_status').textContent = `成功載入 ${data.length} 條記錄。`;
            } catch (error) {
                console.error('Fetch Results Error:', error);
                document.getElementById('result_loading_status').textContent = '載入失敗。';
                document.getElementById('error_message').classList.remove('hidden');
            }
        }

        // 渲染測驗結果表格
        function renderResults(data) {
            const tbody = document.getElementById('result_data_body');
            tbody.innerHTML = '';

            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-gray-500">沒有找到任何測驗結果。</td></tr>';
                return;
            }

            data.forEach((item, index) => {
                const row = tbody.insertRow();
                // 暖色系：表格 hover 顏色
                row.className = 'hover:bg-amber-50 transition duration-150';
                row.onclick = () => showDetail(item, '測驗結果詳情');

                // 時間戳
                row.insertCell().textContent = formatTimestamp(item.timestamp);
                // 會話 ID
                row.insertCell().textContent = item.session_id;
                // 測驗結果名
                row.insertCell().textContent = item.result;
                // 分數詳情 (顯示 JSON 格式，因為後端已解析成物件)
                row.insertCell().textContent = JSON.stringify(item.scores);
            });
        }

        // 顯示詳情 Modal
        function showDetail(item, title) {
            document.getElementById('detail_modal_title').textContent = title;
            // 格式化 JSON 數據使其更易讀
            const content = JSON.stringify(item, null, 2); 
            document.getElementById('detail_content').textContent = content;
            document.getElementById('detail_modal').classList.add('open');
        }

        // 關閉 Modal
        function closeModal() {
            document.getElementById('detail_modal').classList.remove('open');
        }

        // 處理 Tab 切換
        function showTab(tabName) {
            activeTab = tabName;
            
            // 隱藏所有內容
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            // 移除所有按鈕的 active 樣式
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active', 'bg-amber-500', 'text-white');
                button.classList.add('text-gray-700', 'hover:bg-gray-100');
            });

            // 顯示當前 Tab 內容並設置按鈕樣式
            document.getElementById(`content_${tabName}`).classList.add('active');
            const activeBtn = document.getElementById(`tab_${tabName}`);
            activeBtn.classList.add('active', 'bg-amber-500', 'text-white');
            activeBtn.classList.remove('text-gray-700', 'hover:bg-gray-100');
            
            // 重新載入數據
            applyFilters();
        }

        // 套用篩選器
        function applyFilters() {
            if (activeTab === 'events') {
                loadEvents();
            } else if (activeTab === 'results') {
                loadResults();
            }
        }

        // 初始化：預設載入事件
        document.addEventListener('DOMContentLoaded', () => {
            showTab('events');
        });
    </script>
</body>
</html>
